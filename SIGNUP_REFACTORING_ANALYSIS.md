# 회원가입 리팩토링 분석

## 현재 구조 분석

### 현재 상태
- **클라이언트에서 직접 Supabase로 저장**
- **비즈니스 로직이 클라이언트에 있음**
- **Edge Function 없음** (회원가입 관련)

### 클라이언트에 있는 비즈니스 로직
1. **검증 로직**:
   - 생년월일 검증 (만 13세 이상)
   - 핸드폰번호 포맷팅 및 검증
   - 비밀번호 확인 검증
   - 필수 필드 검증

2. **데이터 변환**:
   - 핸드폰번호 포맷팅 (`010-1234-5678` → 숫자만)
   - 날짜 포맷 변환
   - 기본값 설정 (`signup_source: 'web'`, `language: 'ko'`)

3. **에러 처리**:
   - 에러 메시지 분류 및 변환
   - 사용자 친화적 메시지 생성

---

## 리팩토링 필요성 분석

### ⚠️ 현재 구조의 문제점

1. **보안 취약점**
   - 클라이언트 검증은 우회 가능
   - 악의적 사용자가 검증을 우회할 수 있음
   - 예: 생년월일 검증을 우회하여 미성년자 가입 가능

2. **비즈니스 로직 노출**
   - 검증 규칙이 클라이언트 코드에 노출
   - 비즈니스 로직 변경 시 클라이언트 배포 필요

3. **일관성 문제**
   - 다른 기능(analyze)은 Edge Function 사용
   - 회원가입만 클라이언트에서 직접 처리

4. **테스트 어려움**
   - 클라이언트 로직은 E2E 테스트로만 검증 가능
   - 서버 로직은 단위 테스트로 검증 가능

---

## 리팩토링 옵션

### 옵션 1: Edge Function으로 이동 (권장) ⭐

**구조**:
```
[클라이언트]
  └─▶ [Edge Function: signup]
        ├─ 비즈니스 로직 검증
        ├─ 데이터 변환
        └─▶ [Supabase Auth + Database]
```

**장점**:
- ✅ 보안 강화 (서버에서 검증)
- ✅ 비즈니스 로직 중앙화
- ✅ 다른 기능과 일관성 유지
- ✅ 단위 테스트 가능
- ✅ 로직 변경 시 클라이언트 배포 불필요

**단점**:
- ⚠️ Edge Function 추가 개발 필요
- ⚠️ 약간의 지연 시간 증가 (미미함)

**구현**:
```typescript
// supabase/functions/signup/index.ts
Deno.serve(async (req) => {
  const { email, password, nickname, birth_date, gender, phone_number, country } = await req.json()
  
  // 서버에서 검증
  if (!validateAge(birth_date)) {
    return new Response(JSON.stringify({ error: '만 13세 이상만 가입 가능' }), { status: 400 })
  }
  
  // Supabase Auth 회원가입
  // 트리거가 자동으로 public.users 생성
})
```

---

### 옵션 2: 트리거 활용 (현재 + 개선)

**구조**:
```
[클라이언트]
  └─▶ [Supabase Auth]
        └─▶ [트리거: handle_new_user()]
              └─▶ [public.users 자동 생성]
```

**장점**:
- ✅ 클라이언트 코드 간소화
- ✅ 데이터베이스 레벨에서 처리 (안전)
- ✅ 추가 서버 없음

**단점**:
- ⚠️ 복잡한 비즈니스 로직 구현 어려움
- ⚠️ 검증 로직을 트리거에 넣기 어려움
- ⚠️ 에러 처리 제한적

---

### 옵션 3: 하이브리드 (권장) ⭐⭐

**구조**:
```
[클라이언트]
  ├─ 클라이언트 검증 (UX용, 빠른 피드백)
  └─▶ [Edge Function: signup]
        ├─ 서버 검증 (보안용, 필수)
        ├─ 비즈니스 로직
        └─▶ [Supabase Auth + 트리거]
```

**장점**:
- ✅ 이중 검증 (클라이언트 UX + 서버 보안)
- ✅ 빠른 피드백 (클라이언트)
- ✅ 보안 보장 (서버)
- ✅ 일관성 유지

**구현**:
```typescript
// 클라이언트: UX용 빠른 검증
if (!validateBirthDate(formData.birthDate)) {
  setError('만 13세 이상만 가입할 수 있습니다.')
  return
}

// Edge Function: 보안용 필수 검증
// 서버에서도 동일한 검증 수행
```

---

## 권장 리팩토링 방안

### 단계별 구현

#### Phase 1: Edge Function 생성
1. `supabase/functions/signup/index.ts` 생성
2. 비즈니스 로직 이동
3. 검증 로직 서버로 이동

#### Phase 2: 클라이언트 간소화
1. 클라이언트는 UX용 검증만 유지
2. Edge Function 호출로 변경
3. 에러 처리 개선

#### Phase 3: 트리거 개선
1. 트리거에서 모든 필드 자동 저장
2. 클라이언트에서 upsert 제거

---

## 비교표

| 항목 | 현재 (클라이언트) | 옵션 1 (Edge Function) | 옵션 2 (트리거) | 옵션 3 (하이브리드) |
|------|------------------|----------------------|----------------|-------------------|
| 보안 | ⚠️ 낮음 | ✅ 높음 | ✅ 높음 | ✅ 높음 |
| UX | ✅ 빠름 | ✅ 빠름 | ✅ 빠름 | ✅ 빠름 |
| 일관성 | ❌ 낮음 | ✅ 높음 | ⚠️ 중간 | ✅ 높음 |
| 테스트 | ❌ 어려움 | ✅ 쉬움 | ⚠️ 중간 | ✅ 쉬움 |
| 복잡도 | ✅ 낮음 | ⚠️ 중간 | ⚠️ 중간 | ⚠️ 중간 |
| 유지보수 | ⚠️ 어려움 | ✅ 쉬움 | ⚠️ 어려움 | ✅ 쉬움 |

---

## 결론 및 권장사항

### ✅ **권장: 옵션 3 (하이브리드)**

**이유**:
1. **보안**: 서버에서 필수 검증 수행
2. **UX**: 클라이언트에서 빠른 피드백 제공
3. **일관성**: 다른 기능(analyze)과 동일한 패턴
4. **확장성**: 향후 비즈니스 로직 추가 용이

### 구현 우선순위

1. **즉시**: Edge Function 생성 및 기본 검증
2. **단기**: 클라이언트 간소화
3. **중기**: 트리거 개선 (자동 저장)

---

**결론**: 리팩토링이 필요합니다. 특히 보안과 일관성을 위해 Edge Function으로 비즈니스 로직을 이동하는 것을 권장합니다.


