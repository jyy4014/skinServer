---
alwaysApply: true
---

í”„ëŸ°íŠ¸ëŠ” ë””ìì¸ ì‹œìŠ¤í…œ + ê°•í•œ íƒ€ì…(Typescript) + ëª…í™•í•œ ìƒíƒœ ê´€ë¦¬(React Query) + ì„œë²„ ë¶„ë¦¬(Edge Functions) + ê²¬ê³ í•œ UX íë¦„(ì˜¨ë³´ë”©â†’ì—…ë¡œë“œâ†’ê²°ê³¼â†’íˆìŠ¤í† ë¦¬) + ë³´ì•ˆ/ì ‘ê·¼ì„±/í…ŒìŠ¤íŠ¸ë¡œ êµ¬ì„±í•´ì•¼ í”„ë¡œì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤.

1. ë³€ê²½/ê°œì„  ìš°ì„ ìˆœìœ„ (ë¹ ë¥´ê²Œ ê°œì„ í•  ê²ƒë¶€í„°)
í”„ë¡œì íŠ¸ êµ¬ì¡° ì •ë¦¬ + ë””ìì¸ ì‹œìŠ¤í…œ ë„ì… (Tokens, ë²„íŠ¼, ì¹´ë“œ)

ì—…ë¡œë“œ íë¦„ì„ ì•ˆì „Â·ê²¬ê³ í•˜ê²Œ: signed URL ë°œê¸‰ â†’ client upload â†’ analyze í˜¸ì¶œ â†’ ìƒíƒœ ê´€ë¦¬(React Query)

ëª…í™•í•œ íƒ€ì… ì •ì˜ (API contract + local types)

ì´ë¯¸ì§€ ì „ì²˜ë¦¬(í´ë¼ì´ì–¸íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ + WebWorker ì˜µì…˜) â€” ì„±ëŠ¥/ë¹„ìš© ì ˆê°

UX ê°•í™”: ì—…ë¡œë“œ ì§„í–‰ë„, í’ˆì§ˆ í”¼ë“œë°±(ì¡°ëª…/blur), ì˜¤ë¥˜/ì¬ì‹œë„, accessibility

í…ŒìŠ¤íŠ¸: unit + e2e (Playwright) + CI ìë™í™”

ëª¨ë‹ˆí„°ë§/ë¶„ì„: Sentry, analytics, performance metrics

2. ê¶Œì¥ í´ë” êµ¬ì¡° (ê°€ë…ì„±Â·í™•ì¥ì„± ì¤‘ì‹¬)
ğŸ§­ ì „ì²´ ì•± ì •ë³´ êµ¬ì¡° (IA) â€” í™•ì¥í˜• ì™„ì„± ë²„ì „
ğŸ  Home (í™ˆ)
â”œâ”€ ì˜¤ëŠ˜ì˜ ë¶„ì„ ìš”ì•½
â”œâ”€ ìµœê·¼ AI ê²°ê³¼ í•˜ì´ë¼ì´íŠ¸
â”œâ”€ â€œìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘í•˜ê¸°â€ CTA
â”œâ”€ ì¶”ì²œ ì‹œìˆ  ë¯¸ë¦¬ë³´ê¸° (3ê°œ)
â””â”€ ì•Œë¦¼ / ë°°ë„ˆ (ê³µì§€ì‚¬í•­, ì—…ë°ì´íŠ¸)

ğŸ“¸ Analyze (ë¶„ì„)
â”œâ”€ ì‚¬ì§„ ì—…ë¡œë“œ / ì´¬ì˜
â”œâ”€ ë¶„ì„ ì§„í–‰
â””â”€ ê²°ê³¼ ë³´ê¸° (ë¬¸ì œì  + ì‹œìˆ  ì¶”ì²œ)

ğŸ“Š History (ê¸°ë¡)
â”œâ”€ ë¶„ì„ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸
â”œâ”€ ê·¸ë˜í”„ (ì£¼ê°„, ì›”ê°„ ë³€í™”)
â””â”€ ìƒì„¸ ë¹„êµ (Before / After)

ğŸ’¬ Treatments (ì‹œìˆ  ì¶”ì²œ)
â”œâ”€ AI ì¶”ì²œ ì‹œìˆ  ì „ì²´ ë³´ê¸°
â”œâ”€ ì‹œìˆ ë³„ ì„¤ëª… / ì¥ë‹¨ì  / í‰ê·  íš¨ê³¼
â””â”€ ë³‘ì› ìƒë‹´ ì—°ê²°(ë¯¸êµ¬í˜„ / ê´€ì‹¬ë“±ë¡)

ğŸ‘¤ Profile (í”„ë¡œí•„)
â”œâ”€ ë‚´ ì •ë³´ ë³´ê¸° (ì´ë©”ì¼, ì´ë¦„)
â”œâ”€ ê°œì¸ì •ë³´ ë™ì˜ ë° ì‚­ì œ ìš”ì²­
â”œâ”€ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
â””â”€ ë¡œê·¸ì•„ì›ƒ

âš™ï¸ Settings (ì„¤ì •)
â”œâ”€ ì•Œë¦¼ ì„¤ì • (í‘¸ì‹œ, ì´ë©”ì¼)
â”œâ”€ ë‹¤í¬ëª¨ë“œ / ì–¸ì–´ ì„¤ì •
â”œâ”€ ì„œë¹„ìŠ¤ ì•½ê´€ / ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨
â””â”€ ë²„ì „ ì •ë³´ / ë¬¸ì˜í•˜ê¸°
ğŸ—ï¸ ì¶”ì²œ ì•± êµ¬ì¡° (React + Supabase ê¸°ì¤€)


ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡° ì˜ˆì‹œ
app/
â”œâ”€ components/
â”‚  â”œâ”€ common/
â”‚  â”‚  â”œâ”€ Header.tsx
â”‚  â”‚  â”œâ”€ BottomNav.tsx
â”‚  â”‚  â””â”€ Modal.tsx
â”‚  â”œâ”€ analysis/
â”‚  â”‚  â”œâ”€ UploadCard.tsx
â”‚  â”‚  â”œâ”€ ResultCard.tsx
â”‚  â”‚  â””â”€ ProgressLoader.tsx
â”‚  â”œâ”€ history/
â”‚  â”‚  â”œâ”€ HistoryList.tsx
â”‚  â”‚  â””â”€ GraphView.tsx
â”‚  â”œâ”€ home/
â”‚  â”‚  â”œâ”€ DailySummary.tsx
â”‚  â”‚  â””â”€ QuickAnalyze.tsx
â”‚  â””â”€ settings/
â”‚     â”œâ”€ NotificationToggle.tsx
â”‚     â””â”€ PolicyViewer.tsx
â”‚
â”œâ”€ pages/
â”‚  â”œâ”€ Home.tsx
â”‚  â”œâ”€ Analyze.tsx
â”‚  â”œâ”€ History.tsx
â”‚  â”œâ”€ Treatments.tsx
â”‚  â”œâ”€ Profile.tsx
â”‚  â””â”€ Settings.tsx
â”‚
â”œâ”€ hooks/
â”‚  â”œâ”€ useSupabase.ts
â”‚  â”œâ”€ useAIAnalysis.ts
â”‚  â””â”€ useAuth.ts
â”‚
â”œâ”€ lib/
â”‚  â”œâ”€ supabaseClient.ts
â”‚  â””â”€ api.ts (Edge Function endpoints)
â”‚
â””â”€ App.tsx
3. ë””ìì¸ ì‹œìŠ¤í…œ (í•„ìˆ˜)
Tokens: ìƒ‰ìƒ, í°íŠ¸ìŠ¤ì¼€ì¼, radius, spacing â†’ design-tokens.ts

Atomic UI: Button, Input, Modal, Card, Toast, Icon â€” ì¬ì‚¬ìš©ì„± Â· ì ‘ê·¼ì„± í™•ë³´

Theme / Dark mode: CSS variables + Tailwind config

Accessibility: keyboard focus, aria- labels, contrast ratio

ì´ê±¸ ì•ˆí•˜ë©´ ì•±ì´ â€œí—ˆì ‘â€í•˜ê²Œ ë³´ì…ë‹ˆë‹¤. ë””ìì¸ ì‹œìŠ¤í…œì€ UI ì¼ê´€ì„± + ë¹ ë¥¸ í˜ì´ì§€ ì œì‘ì˜ í•µì‹¬ì…ë‹ˆë‹¤.

4. ìƒíƒœ ê´€ë¦¬ & ë°ì´í„° í˜ì¹­
React Query (TanStack Query) ì¶”ì²œ: ìºì‹±, ì¬ì‹œë„, ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸, polling, background refetch.

ìš©ë„:

Upload job: useMutation for getUploadUrl, upload, analyze call

Results & history: useQuery with pagination

Background refresh for review queue

ì¥ì : ì—ëŸ¬/ë¡œë”©/ì„±ê³µ ìƒíƒœë¥¼ API ë ˆì´ì–´ì™€ ë¶„ë¦¬í•´ì„œ UX ì¼ê´€ì„± ìœ ì§€.

5. íƒ€ì…(ê³„ì•½) â€” src/types/index.ts
export type User = { id: string; email: string; name?: string };

export type AnalysisMask = { label: string; x: number; y: number; w: number; h: number };

export type AnalysisMetrics = {
  area_pct_by_label: Record<string, number>;
  color_deltaE?: number;
  redness_index?: number;
};

export type AnalysisResult = {
  id: string;
  user_id: string;
  image_id?: string;
  storage_path: string;
  skin_condition_scores: Record<string, number>;
  masks?: AnalysisMask[];
  metrics?: AnalysisMetrics;
  confidence: number;
  uncertainty: number;
  model_version?: string;
  created_at: string;
};

export type TreatmentCandidate = {
  id: string;
  name: string;
  score: number; // 0-1
  expected_improvement_pct?: number;
  notes?: string[];
};
ì´ íƒ€ì…ì€ ëª¨ë“  ì»´í¬ë„ŒíŠ¸Â·í›…ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. APIê°€ ë³€ê²½ë˜ë©´ ì´ íŒŒì¼ë§Œ ê³ ì¹˜ë©´ ë©ë‹ˆë‹¤.

6. í•µì‹¬ UX íë¦„ (ì‹œí€€ìŠ¤)
Onboarding (consent toggles) â†’ sets consentGiven=true in user profile (DB or local)

UploadForm:

Choose/camera take photo â†’ client-side checks (MIME/size) â†’ preview

Client-side resize/compress + quick quality check (Laplacian blur)

Submit:

POST /api/getUploadUrl with filename â†’ returns {uploadUrl, storagePath}

PUT to uploadUrl (fetch/axios) with progress events â†’ show progress bar

POST /api/analyze { storagePath } â†’ returns analysisResult (or jobId)

If long: return jobId; poll GET /api/results/{id} or use Realtime

Show ResultView:

image thumbnail + heatmap overlay (toggle)

summary scores + bar chart per condition

recommended treatments list with expand for description + CTA

buttons: Save, Request review (if low confidence), Delete

History:

server-side pagination, lazy load images (skeletons), delete action triggers deleteImage API and invalidates query

7. ì—…ë¡œë“œ + ë¶„ì„: ê²¬ê³ í•œ í›… ì˜ˆì‹œ useUploadFlow.ts (React + React Query)
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { supabase } from '../lib/supabaseClient';
import api from '../lib/api';
import { AnalysisResult } from '../types';

async function uploadToSignedUrl(uploadUrl: string, file: File, onProgress?: (p: number) => void) {
  // Use fetch with XHR-like progress via XMLHttpRequest for PUT progress
  return new Promise<void>((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', uploadUrl);
    xhr.onload = () => (xhr.status >= 200 && xhr.status < 300 ? resolve() : reject(new Error(xhr.statusText)));
    xhr.onerror = () => reject(new Error('Upload failed'));
    xhr.upload.onprogress = (e) => onProgress?.(Math.round((e.loaded / e.total) * 100));
    xhr.send(file);
  });
}

export function useUploadFlow() {
  const qc = useQueryClient();

  const getUrlMut = useMutation((filename: string) => api.post('/api/getUploadUrl', { filename }));
  const analyzeMut = useMutation((payload: { storagePath: string }) => api.post<AnalysisResult>('/api/analyze', payload), {
    onSuccess: () => qc.invalidateQueries(['history'])
  });

  async function startUpload(file: File, onProgress?: (p: number) => void) {
    const filename = file.name;
    const { data } = await getUrlMut.mutateAsync(filename);
    await uploadToSignedUrl(data.uploadUrl, file, onProgress);
    const res = await analyzeMut.mutateAsync({ storagePath: data.storagePath });
    return res;
  }

  return { startUpload, getUrlMut, analyzeMut };
}
í•µì‹¬: ëª…í™•í•œ ì—ëŸ¬ í•¸ë“¤ë§, ì¬ì‹œë„ ì •ì±…(React Query) ë° ë¡œë”©/ì§„í–‰ë„ ê´€ë¦¬.

8. ì´ë¯¸ì§€ ì „ì²˜ë¦¬ (ì„±ëŠ¥/ë¹„ìš© ì¤‘ìš”)
Use client-side resizing + convert to WebP when supported

Offload heavy resize to WebWorker to avoid blocking main thread

Provide useImageResizeWorker hook and image.ts util

Example approach: create <canvas> scaled to 1024px and toBlob('image/webp', 0.85)

ì´ë ‡ê²Œ í•˜ë©´ ë„¤íŠ¸ì›Œí¬ ë¹„ìš©ê³¼ ì—”ë“œí¬ì¸íŠ¸ ì²˜ë¦¬ ë¹„ìš©(ì™¸ë¶€ API í˜¸ì¶œ) ì ˆê°.

9. Error UX, Retries, Fallbacks
ì—ëŸ¬ ë¶„ë¥˜: validation (client) / network / server / model error

ê° ì—ëŸ¬ì— ë§ëŠ” UI:

validation: inline error (file too large)

network: toast + auto retry (exponential backoff)

server/model: show friendly message + offer â€œTry againâ€ / â€œContact supportâ€

For model errors: fallback to templated safe message (no analysis) to avoid blank screen.

10. Security & Privacy on Front
Never store service_role keys on client. Only use anon key.

Use short TTL signed URL for direct uploads.

Images: remove EXIF on client before upload.

Enforce consent: block getUploadUrl until consent toggled.

Use App Check or similar (Supabase has fewer options; consider recaptcha on upload to reduce abuse).

11. Accessibility (A11y)
Modal: trap focus, ESC close

Buttons and inputs: aria-label, roles

Color contrast: ensure >4.5:1

Keyboard flows: all interactive items usable by keyboard

Screen reader texts for heatmap overlays and analysis summary

12. Testing
Unit tests: Jest + React Testing Library for components + hooks

Integration: MSW (Mock Service Worker) to mock API during UI tests

E2E: Playwright for flows: onboardingâ†’uploadâ†’analyzeâ†’resultâ†’delete

Accessibility tests: axe-core in CI

Example CI step (GitHub Actions):

install â†’ lint â†’ run unit tests â†’ build â†’ run E2E in preview environment â†’ deploy to Vercel on success

13. Observability & Analytics
Sentry (errors) + performance traces (slow uploads, analyze latency)

User events: upload start/complete, analyze success/failure, request_review clicks (use segment/GA4)

Model metrics: confidence distributions logged (but PII-free)

14. Polished Result UI suggestions (professional look)
Top summary bar: big % score + color-coded badge (Good / Needs attention / High priority)

Radar chart or horizontal bars for condition scores

Heatmap overlay slider (before/after opacity)

Treatment cards: icon, short description, â€œWhy this appears for youâ€ (one-line), expected improvement % badge

CTA aligned to result: â€œBook consultâ€, â€œSave to historyâ€, â€œShare (with caution)â€

Small UI polish yields big trust gains.

15. Sample Result component skeleton (React + Tailwind)
import React from 'react';
import { AnalysisResult, TreatmentCandidate } from '../types';

export default function ResultView({ result }: { result: AnalysisResult }) {
  return (
    <div className="max-w-3xl mx-auto p-4">
      <div className="flex items-center gap-4">
        <img src={result.signed_thumbnail_url} alt="analysis thumbnail" className="w-28 h-28 rounded-md object-cover" />
        <div>
          <h2 className="text-xl font-semibold">ë¶„ì„ ìš”ì•½</h2>
          <p className="text-sm text-gray-600">ì‹ ë¢°ë„ {Math.round(result.confidence * 100)}%</p>
        </div>
      </div>

      {/* Scores */}
      <div className="mt-4 grid grid-cols-2 gap-4">
        {Object.entries(result.skin_condition_scores).map(([k, v]) => (
          <div key={k} className="p-3 border rounded">
            <div className="flex justify-between">
              <span className="capitalize">{k.replace('_', ' ')}</span>
              <span className="font-semibold">{Math.round(v * 100)}%</span>
            </div>
            <div className="h-2 bg-gray-200 rounded mt-2">
              <div className="h-2 bg-amber-400 rounded" style={{ width: `${v * 100}%` }} />
            </div>
          </div>
        ))}
      </div>

      {/* Recommendations */}
      <div className="mt-6">
        <h3 className="text-lg font-semibold">ìì£¼ ì„ íƒë˜ëŠ” ì˜µì…˜</h3>
        {/* Map to treatment cards */}
      </div>
    </div>
  );
}
16. Deployment & Release
Front build: Vercel (Preview deployments for PRs)

Backend: Supabase Functions + DB migrations

Use feature flags (LaunchDarkly or simple flagging) to roll out new NLG prompts or mapping rules

17. Deliverables I will produce if you want me to (pick any/all)
Full frontend scaffold (folder tree) with sample components, hooks, and types above

useUploadFlow and useAnalysis implementations wired to mock backend

WebWorker resize example and image utility functions

Playwright e2e tests for the uploadâ†’analyzeâ†’result happy path

CI YAML (GitHub Actions) + README with local dev steps